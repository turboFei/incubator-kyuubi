#!/usr/bin/env bash
#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

set -o pipefail
set -e
set -x

REPLACE_SELF=false
KYUUBI_HOME="$(cd "`dirname "$0"`/.."; pwd)"
WORKING_KYUUBI_HOME=/tmp/kyuubi_client_hadoop2_$(date "+%Y%m%d")
HADOOP_VERSION="${HADOOP_VERSION:-"2.7.3.2.6.4.2.0.41"}"
DEPLOY=false
function usage {
  set +x
  echo "./build/dist_client_hadoop2 - Tool for making binary distributions of Kyuubi with hadoop2"
  echo ""
  echo "Usage:"
  echo "+------------------------------------------------------------------------------------------------------+"
  echo "| ./build/dist_client_hadoop2 --replace --working-home --hadoop2-version --deploy                      |"
  echo "+------------------------------------------------------------------------------------------------------+"
  echo "replace:         -  replace the project without copy, otherwise, will copy it to working dir"
  echo "working-home:    -  the working kyuubi home"
  echo "hadoop2-version: -  the hadoop2 version"
  echo "deploy:          -  deploy dependency"
  echo ""
}

function exit_with_usage {
  usage
  exit 1
}

# Parse arguments
while (( "$#" )); do
  case $1 in
    --replace)
      REPLACE_SELF=true
      ;;
    --deploy)
      DEPLOY=true
      ;;
    --working-home)
      WORKING_KYUUBI_HOME="$2"
      shift
      ;;
    --hadoop2-version)
      HADOOP_VERSION="$2"
      shift
      ;;
    --help)
      exit_with_usage
      ;;
    --*)
      echo "Error: $1 is not supported"
      exit_with_usage
      ;;
    -*)
      break
      ;;
    *)
      echo "Error: $1 is not supported"
      exit_with_usage
      ;;
  esac
  shift
done

if [[ ! -f $KYUUBI_HOME/pom.xml ]]; then
  echo "The $KYUUBI_HOME is invalid, there is no parent pom.xml"
  exit 1
fi

echo "Replace $KYUUBI_HOME with hadoop version $HADOOP_VERSION"

if [[ "$REPLACE_SELF" == "true" ]]; then
  WORKING_KYUUBI_HOME=$KYUUBI_HOME
elif [[ "$WORKING_KYUUBI_HOME" != "$KYUUBI_HOME" ]]; then
  rm -rf $WORKING_KYUUBI_HOME
  cp -r $KYUUBI_HOME $WORKING_KYUUBI_HOME
  rm -rf $WORKING_KYUUBI_HOME/.git
fi

sed -i -r 's/<hadoop.version>[0-9.]*<\/hadoop.version>/<hadoop.version>'$(echo $HADOOP_VERSION)'<\/hadoop.version>/g' $WORKING_KYUUBI_HOME/pom.xml

function replace_hadoop_dep() {
  POM=$1
  # echo "Replacing hadoop-client-api/hadoop-client-runtime with hadoop-common/hadoop-client in $POM"
  sed -i -r 's/<artifactId>hadoop-client-api<\/artifactId>/<artifactId>hadoop-common<\/artifactId>/g' $POM
  sed -i -r 's/<artifactId>hadoop-client-runtime<\/artifactId>/<artifactId>hadoop-client<\/artifactId>/g' $POM
  sed -i -r 's/<artifactId>kyuubi-hive-jdbc<\/artifactId>/<artifactId>kyuubi-hive-jdbc_hadoop2<\/artifactId>/g' $POM
  sed -i -r 's/<artifactId>kyuubi-hive-jdbc-shaded<\/artifactId>/<artifactId>kyuubi-hive-jdbc-shaded_hadoop2<\/artifactId>/g' $POM
  sed -i -r 's/<artifactId>kyuubi-rest-client<\/artifactId>/<artifactId>kyuubi-rest-client_hadoop2<\/artifactId>/g' $POM
  sed -i -r 's/<artifactId>kyuubi-hive-jdbc-standalone<\/artifactId>/<artifactId>kyuubi-hive-jdbc-standalone_hadoop2<\/artifactId>/g' $POM
}

replace_hadoop_dep $WORKING_KYUUBI_HOME/pom.xml
for POM in `ls $WORKING_KYUUBI_HOME/**/pom.xml`
do
  replace_hadoop_dep $POM
done
for POM in `ls $WORKING_KYUUBI_HOME/**/**/pom.xml`
do
  replace_hadoop_dep $POM
done
for POM in `ls $WORKING_KYUUBI_HOME/**/**/**/pom.xml`
do
  replace_hadoop_dep $POM
done

# replace the hadoop-client scope with compile in kyuubi-common/pom.xml
sed -i -r 's/<scope>runtime<\/scope>/<scope>compile<\/scope>/g' $WORKING_KYUUBI_HOME/kyuubi-common/pom.xml
rm -rf $WORKING_KYUUBI_HOME/kyuubi-common/src/test/scala/org/apache/kyuubi/util/KyuubiHadoopUtilsSuite.scala

cd $WORKING_KYUUBI_HOME

if [[ "$DEPLOY" == "false" ]];then
  ./build/dist_client --tgz --name hadoop2
else
  ./build/mvn clean deploy -pl kyuubi-hive-jdbc,kyuubi-hive-jdbc-shaded,kyuubi-rest-client,ebay/kyuubi-hive-jdbc-standalone  -DskipTests \
      -DdistMgmtReleaseUrl=http://ebaycentral.qa.ebay.com/content/repositories/releases \
      -DdistMgmtSnapshotsUrl=http://ebaycentral.qa.ebay.com/content/repositories/snapshots
fi
